 #!/bin/sh

# Prerequisites:
# 1. Solr needs to be installed at /usr/local/solr/example
# 2. daemon needs to be installed
# 3. Script needs to be executed by root

# This script will launch Solr in a mode that will automatically respawn if it
# crashes. Output will be sent to /var/log/solr/solr.log. A pid file will be 
# created in the standard location.

start () {
    echo -n "Starting solr..."

    # Use python to determine if this is a dev machine
    DEV=`python -c 'import os.path;
import glob;
conffiles = glob.glob(os.path.join("/var/www/court-listener/alert/settings", "*.conf"));
conffiles.sort();
for f in conffiles:
    execfile(os.path.abspath(f));
print DEVELOPMENT;'`
    
    if [ $DEV = 'True' ]
    then
        xmx=500M
    else
        xmx=5G
    fi    
        
    # start daemon
    daemon --chdir='/usr/local/solr/example' --command "java -jar -server -Xmx$xmx start.jar" --respawn --output=/var/log/solr/solr.log --name=solr --verbose
    
    RETVAL=$?
    if [ $RETVAL = 0 ]
    then
        echo "done."
    else
        echo "failed. See error code for more information."
    fi
    return $RETVAL
}

stop () {
    # stop daemon
    echo -n "Stopping solr..."
    
    daemon --stop --name=solr  --verbose
    RETVAL=$?
    
    if [ $RETVAL = 0 ]
    then
        echo "done."
    else
        echo "failed. See error code for more information."
    fi
    return $RETVAL
}


restart () {
    daemon --restart --name=solr  --verbose
}


status () {
    # report on the status of the daemon
    daemon --running --verbose --name=solr
    return $?
}


case "$1" in
    start)
        start
    ;;
    status)
        status
    ;;
    stop)
        stop
    ;;
    restart)
        stop
        sleep 15
        start
    ;;
    *)
        echo $"Usage: solr {start|status|stop|restart}"
        exit 3
    ;;
esac

exit $RETVAL
