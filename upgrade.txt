This file contains notes for upgrades when special instructions are necessary. In general, simply doing:

hg pull -u
sudo -u www-data $CL_INSTALL_ROOT/alert/manage.py collectstatic
manage.py migrate

is all that's necessary. In the case that special instructions are needed, we will attempt to put them here, with the
most recent at the top.

We welcome a conversion of these notes to a better process using Fabric.

----------------------------

DONATION PROJECT
    - PRE DEPLOY:
        - TODO: Make sure the scrapers are working properly again (see error logs in VM)
        - TODO: Make the annual reminder

    - POST DEPLOY:
        - TODO: Test the "Try Donating Again" button that comes up when you cancel a Dwolla payment.
        - TODO: Make sure that the location field gets mapped into city/state properly

LAWBOX PROJECT
 - TODO: Does the fact that lawbox cases lack a URL cause an issue in the UI or can they be treated like the Resource.org cases?
 - TODO: If we do case merging, the source field should be LBM ("LawBox Merged") or even LBRM ("Lawbox, Resource.org
         Merged.")
 - TODO: Investigate whether it's worth reworking the citation finder so that it better understands neutral citations.
         For example, right now a citation like 2012 NM 3 will get 3 as citation.page, and will get 2012 as
         citation.volume
   TODO: Note that citations aren't always unique! For example, you can have a Dal. Citation that is either from Dallas'
         Supreme Court Reports or from Dallas' Pennsylvania Reports. Make sure that date filtering can handle this. This
         can even happen within the same court. So, Fed.R. can refer to either F. or F.2d.
   TODO: Change the DB to support better granularity of citations:
            + Add the new fields to the model and migrate it.
            - Update the crawler and other code to properly map to the new fields
            + Remove West Cite from the front end (make it say simply citation)
            + Update Solr and investigate how to swap in a better index.
            + Update the advanced search page notes
   TODO: manage.py dumpdata search.court --indent=2 | tee search/fixtures/initial_data.json
   TODO: Update anything that says we have 150 courts.
   TODO: Sort out the new court picking interface.

STABILIZATION
 - TODO: Rework the matcher so it uses dates and continues working.
 - TODO: Purge CL_REPORTERS and REPORTER DATES
 - TODO: Finish the update that split the Citation into a gazillion parts.
 - TODO: Verify that the contact form looks right.
 - TODO: Wrap up the migration to using $CL_INSTALL_ROOT, and document how to do the upgrade for that.

2013-08-27:
 - the user profiles have been updated to support donations. Update your database with:

    manage.py migrate donate
    manage.py migrate userHandling

 - we've added payment support, which introduces a new dependency. Install it with:

    sudo pip install --index-url https://code.stripe.com --upgrade stripe

2013-07-25:
 - A new dependency has been added. Install it with:

   $ sudo aptitude install curl

 - The database has been updated to include date_modified fields, support the lawbox use case, and to support much
   greater citation granularity. Migrate your database with:

    manage.py migrate search
    manage.py migrate favorites

 - Our data dumps have been expanded to continue mirroring our database. They now contain many additional fields for
   citations: federal_cite_one, federal_cite_two, federal_cite_three, state_cite_one, state_cite_two, state_cite_three,
   state_regional_cite, specialty_cite_one, scotus_early_cite and westlaw_cite. The goal of this change is to provide
   much greater granularity to those that are importing this data, splitting out parallel citations into more
   understandable fields.

   Be sure to delete old copies of the dumps so they are no longer cached.

 - The Solr backend has been updated to deprecate the westCite field and rename it as simply "citation". The old field
   will continue working for at least one year, though alerts and documentation have been updated.

   To create a new Solr core and smoothly swap it in takes a few incantations:

   First, set up a session that supports (dis/re)connection:
     % screen

   Halt the scrapers and restart Solr to bring in the new schema
     % sudo service scrapers stop
     % sudo service solr restart

   Create a new Solr core named "swap_core", using the normal core's settings:
     % curl 'http://localhost:8983/solr/admin/cores?wt=json&action=CREATE&name=swap_core&instanceDir=%2Fusr%2Flocal%2Fsolr%2Fexample%2Fsolr%2Fcollection1&dataDir=data&config=solrconfig.xml&schema=schema.xml'

   The cl_update_index command has been updated with a new argument, --solr-url, that allows users to override the
   default SOLR_URL value that is normally pulled from the site-wide settings. Use the new argument to reindex all
   content to the new core we just created. This will take several hours and require twice the disk space and memory
   your Solr index currently uses:
     % manage.py cl_update_index --everything --update --optimize --solr-url='http://127.0.0.1:8983/solr/swap_core'

   Once complete, swap the indexes with:
     % curl 'http://localhost:8983/solr/admin/cores?wt=json&action=SWAP&core=collection1&other=swap_core'

   Delete the old core and index:
     % curl 'http://localhost:8983/solr/admin/cores?wt=json&action=UNLOAD&core=swap_core&deleteIndex=true'

   And finally, restart the scrapers:
     % sudo service scrapers start

 - The variables SERVER_EMAIL and DEFAULT_FROM_EMAIL have been changed from 'noreply@courtlistener.com' to
   'CourtListener <noreply@courtlistener.com>' to provide a proper name to email readers. This is changed in the default
   variable file, but can be overridden in your 05-private.py file, if desired.

 - A new page has been added at /api/jurisdictions/ if you wish to include it in your sitemaps.


2013-07-07:
 - The piwik configuration has been merged into the virtual host for the main site. If you are using piwik, you will
   need to restart your apache server to enable this configuration. After this change, piwik will be located at
   /piwik rather than as a subdomain.


2013-07-03:
 - Adds a notes field to the Courts model. Migrate your database with:

    manage.py migrate search

   And you'll be good to go.

2013-06-27:
 - This release will require downtime and will put your site into management mode upon pulling it.
 - judge, suitNature and citeCount have been added to the Solr configuration. judges and nature_of_suit have been added
   to the Document model.Unfortunately, these require a recrawl of the database into the Solr index and a migration of
   the database. To realize these changes:

     sudo -u www-data pull -u
     sudo service apache2 restart # Welcome to management mode.
     sudo servce scraper stop
     manage.py migrate search
     manage.py cl_update_index --delete --everything
     sudo service solr restart
     sudo service celeryd restart
     manage.py cl_update_index --update --everything
     sudo servce scraper start

   There have also been changes to the settings to enable staticfiles as indicated below, and settings have been
   overhauled to make them much simpler.

   To effect the changes to settings, copy 05-private.example to 05-private.py, and edit it as needed. Once complete,
   delete 20-private.py or rename it with a different extension, if you need a backup.

   At this point your system should be upgraded, and you can disable the management mode in urls.py, then restart apache
   again.

 - We've moved to using django.contrib.staticfiles[1]. This introduces better management of static files and moves CL
   towards standard Django practices in versions >= 1.3, but presents several changes for the project:
    - When deploying, there are new commands that must be run if there are any new static files:
       manage.py collectstatic
    - The locations of static files have been distributed to either the app they correspond with or to a new directory,
      "alert/assets/static-global", that contains static items that have a global scope across apps. Within each app
      there is a /static/ directory where their own static files should go. Files are not served from these locations,
      but are instead collected into the "alert/assets/static/" directory upon deploying the app.
    - Changes have been made to the apache configuration which will make it serve files from the new location. These
      changes require that Apache be restarted after pulling from hg.
    - urls.py has been simplified, since django.contrib.staticfiles serves static files automatically when
      DEBUG == True.
    - Nearly all templates have been altered to use this app, introducing the possibility of missing images, css or JS.

 [1]: https://docs.djangoproject.com/en/1.3/howto/static-files/#staticfiles-in-templates


2013-06-20:
 - The add_citations script has been converted to a management command. Any previous usages of it will need to be
   updated to use manage.py cl_add_citations_to_docs. It remains mostly API compatible, but management commands do
   not support variable numbers of arguments so the doc_ids parameter is now doc_id. It takes an int instead of an
   iterable.

2013-06-19:
 - Numerous changes to the models have been made to rename variables. Please update your database after pulling the
   code. This should be an instant migration in PostGres.

     manage.py migrate search

 - The dependency on the requests library has been updated to version 1.2.3:

   sudo pip uninstall requests
   sudo apt-get purge python-requests
   sudo pip install requests==1.2.3

 - The scrape_and_extract.py script has been converted to the cl_scrape_and_extract management command. It is API
   compatible in terms of args, but any jobs calling the script will need to be updated.




