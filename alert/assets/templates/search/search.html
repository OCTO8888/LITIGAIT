{% extends 'base.html' %}
{% load text_filters %}
{% load humanize %}
{% load highlight %}

{# this could mirror the titles of yahoo, google and bing more closely, if we want. #}
{% block title %} CourtListener.com / Results / {{ query }} /
    {% if results.paginator.num_pages %}
    Page / {{ results.number }} of {{results.paginator.num_pages}}
    {% endif %}
    {# TODO: Make sure that this section is updated #}
{% endblock %}

{% block head %}
	<link rel="stylesheet" href="/media/css/jquery.tooltip.css" type="text/css" media="screen, projection">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<script type="text/javascript" src="/media/js/jquery.tooltip.min.js"></script>
	<script type="text/javascript">
	   $(document).ready(function() {
	       $('.auto-focus:first').focus();
	       $('.sidebar-section > h3').click(function () {
	    	   $(this).next('.hidden').toggle('fast');
	    	   $(this).next('.shown').toggle('fast');
	           $(this).toggleClass('collapsed-heading');
	           $(this).toggleClass('expanded-heading');
	           $(this).toggleClass('arrow-right-before');
	           $(this).toggleClass('arrow-down-before');
	       });
	       $('#q').tooltip({
	           track: false,
	           delay: 1,
	           showURL: false,
	           showBody: " - ",
	           fade: 250,
	           positionLeft: true
	       });
	   });
	</script>
	<link rel="alternate" type="application/rss+xml" title="CourtListener.com search atom feed" href="/feed/search/?q={{query}}" />
	<link rel="canonical" href="http://courtlistener.com/search/results/{%if query%}?q={{query}}{%endif%}" />
{% endblock %}


{% block sidebar %}
    <div class="span-5 append-2" id="sidebar">
        <div class="sidebar-section">
            <h3 class="pointer collapsed-heading arrow-right-before">Create alert</h3>
            <div id="hidden-create-alert" class="hidden">
		        {% if query %}
		           {% if user.is_authenticated %}
	                    {% if alertForm.errors %}
	                        <div class="span-4 error">
	                            <p class="bottom">Please fix the errors below.</p>
	                        </div>
	                    {% endif %}

	                    <form action="" method="post">{% csrf_token %}
	                        <p>
	                            <label for="id_alertText">Alert query</label>
	                            {% if alertForm.alertText.errors %}
	                                <br><span class="errortext">
	                                    {% for error in alertForm.alertText.errors %}
	                                        {{ error|escape }}
	                                    {% endfor %}
	                                </span>
	                            {% endif %}<br>
	                            {{ alertForm.alertText }}
	                        </p>
	                        <p>
	                            <label for="id_alertName">Give the alert a name</label>
	                            {% if alertForm.alertName.errors %}
	                                <br><span class="errortext">
	                                    {% for error in alertForm.alertName.errors %}
	                                        {{ error|escape }}
	                                    {% endfor %}
	                                </span>
	                            {% endif %}
	                            {{ alertForm.alertName }}
	                        </p>
	                        <p>
	                            <label for="id_alertFrequency">How often should we notify you</label>
	                            {% if alertForm.alertFrequency.errors %}
	                                <br><span class="errortext">
	                                    {% for error in alertForm.alertFrequency.errors %}
	                                        {{ error|escape }}
	                                    {% endfor %}
	                                </span>
	                            {% endif %}<br>
	                            {{ alertForm.alertFrequency }}
	                        </p>
	                        <p>
	                            {{ alertForm.alertPrivacy }}
	                            <label for="id_alertPrivacy">This alert is private</label>
	                            <label style="color:#000099; font-weight:normal;" title=" - In the future, we may allow users to share their public alerts." href="#" id="q" class="help">[?]</label>
	                            {% if alertForm.alertPrivacy.errors %}
	                                <span class="errortext">
	                                    {% for error in alertForm.alertPrivacy.errors %}
	                                        {{ error|escape }}
	                                    {% endfor %}
	                                </span>
	                            {% endif %}<br>
	
	                        </p>
	                        <p>
	                            {{ alertForm.sendNegativeAlert }}
	                            <label for="id_alertName">Send me alerts even when there are no hits</label>
	                            {% if alertForm.sendNegativeAlert.errors %}
	                                <span class="errortext">
	                                    {% for error in alertForm.sendNegativeAlert.errors %}
	                                        {{ error|escape }}
	                                    {% endfor %}
	                                </span>
	                            {% endif %}<br>
	                        </p>
	                        <button type="submit" class="button title" name="alertSave">Create alert</button>
	                    </form>

			        {% else %}
			            {# User is not authenticated #}
		                <div id="hidden-create-alert" class="hidden">
		                    <p>To get daily alerts for this search, <a href="{%url sign-in%}?next={{request.path}}?q={{query}}&page={{results.number}}">sign in</a> or
		                    <a href="{%url register%}?next={{request.path}}?q={{query}}&page={{results.number}}">register</a> as a new user.</p>
		                </div>
			        {% endif %}
	            {% else %}
	                {# no query was placed #}
	                <p>To create an alert, place a query or filter the results.</p>
	            {% endif %}
            </div>

	        <div class="sidebar-section">
	            <h3 class="pointer expanded-heading arrow-down-before">Refine your search</h3>
	            <div class="shown">
	                <h4 class="bottom">Federal Courts</h4>
	                {% for court in facets.fields.court %}
	                    <p class="bottom">
	                        <a href="{{ request.get_full_path }}&amp;selected_facets=court_exact:{{ court.0|urlencode }}">
	                            {{ court.0 }}
	                        </a>
	                        <span class="gray small">({{ court.1 }})</span>
	                    </p>
	                {% endfor %}
	                <hr class="space">
	                
	                <h4 class="bottom">Status</h4>
	                {% for status in facets.fields.status %}
	                    <p class="bottom">
	                        <a href="{{ request.get_full_path }}&amp;selected_facets=status_exact:{{ status.0|urlencode }}">
	                            {{ status.0 }}
	                        </a>
	                        <span class="gray small">({{ status.1 }})</span>
	                    </p>
	                {% endfor %}
	            </div>
	        </div>
        </div>
    </div>
{% endblock %}


{% block content %}
    <div class="span-17 last">
        {% if messages %}
            {# TODO: Make sure this works and looks right #}
            <div class="span-17 last">
                {% for message in messages %}
                    <p class="bottom {{message.tags}}">{{message|safe}}</p>
                {% endfor %}
            </div>
        {% endif %}
        
        {% if paginator.count > 0 %}
            <h2 id="result-count">{{ paginator.count|intcomma }} Result{{ paginator.count|pluralize }}</h2>
            <select id="result-order-chooser">
	            <option>Relevance</option>
	            <option>Date: newest first</option>
	            <option>Date: oldest first</option>
	        </select>
	        <hr class="space"/>
            {% for result in page.object_list %}
	            {% if result.object.documentType = "Published" %}
                    <div class="green-circle" title="This is a {{result.object.get_documentType_display}} opinion"></div>
                {% else %} 
                    {% if result.object.documentType = "Unpublished" or result.object.documentType = "Errata" or result.object.documentType = "In-chambers" or result.object.documentType = "Relating-to" %}
                        <div class="red-circle" title="This is a {{result.object.get_documentType_display}} opinion"></div>
                    {% else %}
                        <div class="orange-circle" title="The status of this opinion is unknown"></div>
                    {% endif %}
                {% endif %}
     
	            <h3 class="bottom serif">
	                <a href="{{result.object.get_absolute_url}}?q={{query}}" class="visitable">
	                    {% highlight result.caseName with query max_length 200000000000000 %},
	                    {% if result.westCite != '' and result.westCite != None %}
	                        {{ result.westCite }}
	                    {% else %}
	                        {{ result.docketNumber }}
	                    {% endif %}
	                    ({% if result.court != 'SCOTUS' %}{{ result.court|nbsp }}&nbsp;{% endif %}{{ result.dateFiled|date:"Y" }})
	                </a>
	            </h3>
	            <p class="bottom">
	                {% if result.object.download_URL or result.object.local_path %}
	                    {% if result.object.source != 'R' %}
	                        <span class="meta-data-header">View Original:</span>
	                        <span class="meta-data-value">
		                        {% if result.object.download_URL %}
		                            <a href="{{result.object.download_URL}}" class="visitable">From the court</a>
		                        {% endif %}
		                        {% if result.object.download_URL and result.object.local_path %}
		                            &nbsp;&nbsp;|&nbsp;&nbsp;
		                        {% endif %}
		                        {% if result.object.local_path %}
		                            <a href="/{{result.object.local_path}}" class="visitable">Our backup</a>
		                        {% endif %}
	                        </span>
	                    {% else %}
	                        <span class="meta-data-value">No downloadable versions.</span>
	                    {% endif %}
	                {% else %}
	                    <span class="meta-data-value">No downloadable versions.</span>
	                {% endif %}
	           
	                <span class="meta-data-header">Date Filed:</span>
	                <span class="meta-data-value">
		                {% if result.dateFiled %}
		                    {{result.dateFiled|date:"l, F jS, Y"}}
		                {% else %}
		                    Unknown date
		                {% endif %}
	                </span>
	            </p>
	            <p class="bottom">
	                {% if result.westCite != '' and result.westCite != None and result.docketNumber %}
                        <span class="meta-data-header">Docket Number:</span>
                        <span class="meta-data-value">{{ result.docketNumber }}</span>
                    {% endif %}
	            </p>
	            <p>
	                {% highlight result.text with query max_length 400 %}
	            </p>
            {% endfor %}      
        {% else %}
            <h2 class="alt">Your search &mdash; <strong>{{query}}</strong> &mdash; had no results.</h2>
            <h4 class="bottom">Search tips:</h4>
            <ul>
                <li>Check your spelling</li>
                <li>Try fewer filters</li>
                <li>Remove quotes if you used them</li>
            </ul>
            <p>Did you expect more results than this? If so, <a href="/contact/">let us know</a>! We value your feedback.</p>
        {% endif %}
        
        {% if page.has_previous or page.has_next %}
            <div class="box">
                <div id="pagination-left">
                    <h3 class="bottom arrow-left-before">
                        {% if page.has_previous %}<a href="?q={{ query }}&amp;page={{ page.previous_page_number }}">{% endif %}Previous{% if page.has_previous %}</a>{% endif %}
                    </h3>
                </div>
                <div id="pagination-right">
                    <h3 class="bottom arrow-right-after">
                        {% if page.has_next %}<a href="?q={{ query }}&amp;page={{ page.next_page_number }}">{% endif %}Next{% if page.has_next %}</a>{% endif %}
                    </h3>
                </div>
                <div id="pagination-center">
                    <h3 class="bottom">
                        Page {{ page.number }} of {{ page.paginator.num_pages }}
                    </h3>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}